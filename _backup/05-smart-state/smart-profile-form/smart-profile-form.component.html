<div class="container mx-auto p-6">
  <div class="prose mb-6 max-w-none">
    <h2>Smart Profile Form</h2>
    <p>
      Purpose: Demonstrate smart state patterns with external data sync,
      conflict handling, and user-driven resolution strategies.
    </p>
    <p class="text-sm">
      See:
      <a
        href="https://github.com/simplifiedcourses/ngx-vest-forms"
        target="_blank"
        >README</a
      >
      Â· <a href="https://vestjs.dev" target="_blank">Vest Docs</a>
    </p>
  </div>
  <h1 class="mb-6 text-3xl font-bold">Smart User Profile</h1>

  <div class="mb-6 rounded-lg border border-blue-300 bg-blue-50 p-4 shadow-md">
    <h2 class="mb-3 text-xl font-semibold text-blue-700">
      External Data Controls
    </h2>
    <p class="mb-2 text-sm text-gray-600">
      Simulate external changes to the user profile.
    </p>
    <div class="flex gap-2">
      <button
        type="button"
        (click)="simulateExternalChangeMajor()"
        class="focus:ring-opacity-50 rounded bg-blue-500 px-4 py-2 text-white shadow hover:bg-blue-600 focus:ring-2 focus:ring-blue-500 focus:outline-none"
      >
        Simulate Major External Update (e.g., Admin Edit)
      </button>
      <button
        type="button"
        (click)="simulateExternalChangeMinor()"
        class="focus:ring-opacity-50 rounded bg-teal-500 px-4 py-2 text-white shadow hover:bg-teal-600 focus:ring-2 focus:ring-teal-500 focus:outline-none"
      >
        Simulate Minor External Update (e.g., Last Login)
      </button>
    </div>
    @if (externalUserData(); as extUser) {
      <div class="mt-4 rounded bg-blue-100 p-3 text-xs">
        <h4 class="font-semibold">Current External Data:</h4>
        <pre>{{ extUser | json }}</pre>
      </div>
    }
  </div>

  <form
    ngxVestForm
    #profileForm="ngxVestForm"
    [vestSuite]="userProfileSuite"
    [(formValue)]="userProfile"
    (ngSubmit)="onSubmit(profileForm.formState())"
    class="flex flex-col gap-6 rounded-lg border border-gray-300 bg-white p-6 shadow-md"
  >
    <ngx-control-wrapper class="block">
      <label
        for="firstName"
        class="mb-1 block text-sm font-medium text-gray-700"
        >First Name</label
      >
      <input
        id="firstName"
        name="firstName"
        type="text"
        [ngModel]="userProfile().firstName"
        class="block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm"
        autocomplete="off"
      />
    </ngx-control-wrapper>

    <ngx-control-wrapper class="block">
      <label for="lastName" class="mb-1 block text-sm font-medium text-gray-700"
        >Last Name</label
      >
      <input
        id="lastName"
        name="lastName"
        type="text"
        [ngModel]="userProfile().lastName"
        class="block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm"
        autocomplete="off"
      />
    </ngx-control-wrapper>

    <ngx-control-wrapper class="block">
      <label for="email" class="mb-1 block text-sm font-medium text-gray-700"
        >Email</label
      >
      <input
        id="email"
        name="email"
        type="email"
        [ngModel]="userProfile().email"
        class="block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm"
        autocomplete="off"
      />
    </ngx-control-wrapper>

    <ngx-control-wrapper class="block">
      <label for="bio" class="mb-1 block text-sm font-medium text-gray-700"
        >Bio (Optional)</label
      >
      <textarea
        id="bio"
        name="bio"
        [ngModel]="userProfile().bio"
        rows="3"
        class="block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm"
        autocomplete="off"
      ></textarea>
    </ngx-control-wrapper>

    <fieldset class="rounded-md border border-gray-200 p-4">
      <legend class="text-base font-medium text-gray-900">Settings</legend>
      <ngx-control-wrapper class="mt-4 flex flex-col gap-4">
        <div class="flex items-start">
          <div class="flex h-5 items-center">
            <input
              id="receiveNewsletter"
              name="receiveNewsletter"
              type="checkbox"
              [ngModel]="userProfile().receiveNewsletter"
              class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500"
            />
          </div>
          <div class="ml-3 text-sm">
            <label for="receiveNewsletter" class="font-medium text-gray-700"
              >Receive Newsletter</label
            >
          </div>
        </div>
      </ngx-control-wrapper>

      <div
        ngModelGroup="notificationPreferences"
        class="mt-4 flex flex-col gap-2"
      >
        <h4 class="text-sm font-medium text-gray-700">
          Notification Preferences:
        </h4>
        <ngx-control-wrapper>
          <div class="flex items-center">
            <input
              id="pushNotifications"
              name="push"
              type="checkbox"
              [ngModel]="userProfile().notificationPreferences.push"
              class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500"
            />
            <label
              for="pushNotifications"
              class="ml-2 block text-sm text-gray-900"
              >Push Notifications</label
            >
          </div>
        </ngx-control-wrapper>
        <ngx-control-wrapper>
          <div class="flex items-center">
            <input
              id="emailNotifications"
              name="email"
              type="checkbox"
              [ngModel]="userProfile().notificationPreferences.email"
              class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500"
            />
            <label
              for="emailNotifications"
              class="ml-2 block text-sm text-gray-900"
              >Email Notifications</label
            >
          </div>
        </ngx-control-wrapper>
        <ngx-control-wrapper>
          <div class="flex items-center">
            <input
              id="smsNotifications"
              name="sms"
              type="checkbox"
              [ngModel]="userProfile().notificationPreferences.sms"
              class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500"
            />
            <label
              for="smsNotifications"
              class="ml-2 block text-sm text-gray-900"
              >SMS Notifications</label
            >
          </div>
        </ngx-control-wrapper>
      </div>
    </fieldset>

    <div class="flex items-center justify-between pt-4">
      <button
        type="submit"
        [disabled]="
          profileForm.formState().pending || profileForm.formState().invalid
        "
        class="rounded-md bg-indigo-600 px-4 py-2 text-sm font-semibold text-white shadow-sm hover:bg-indigo-500 focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-indigo-600 disabled:opacity-50"
      >
        Save Profile
      </button>
      <button
        type="button"
        (click)="resetForm()"
        class="rounded-md bg-gray-200 px-4 py-2 text-sm font-semibold text-gray-700 hover:bg-gray-300"
      >
        Reset to Initial (External)
      </button>
    </div>

    <!-- Smart State features temporarily disabled for build compatibility -->
    <!--
    @if (profileForm.smartState()?.conflictState; as conflictState) {
      @if (conflictState.hasConflicts) {
        <div class="mt-4 rounded-md bg-orange-50 p-4">
          <h3 class="text-lg font-medium text-orange-700">
            Data Conflict Detected!
          </h3>
          <p class="text-sm text-orange-600">
            The profile data was updated externally while you were editing.
          </p>
          <div class="mt-3 flex gap-2">
            <button
              (click)="resolveConflict('local')"
              class="rounded bg-orange-500 px-3 py-1 text-white hover:bg-orange-600"
            >
              Keep My Changes
            </button>
                <!-- Smart State features temporarily disabled for build compatibility -->
    <!--
              class="rounded bg-red-500 px-3 py-1 text-white hover:bg-red-600"
            >
              Keep My Changes
            </button>
            <button
              (click)="resolveConflict('external')"
              class="rounded bg-green-500 px-3 py-1 text-white hover:bg-green-600"
            >
              Accept External Changes
            </button>
            <button
              (click)="resolveConflict('merge-review')"
              class="rounded bg-yellow-500 px-3 py-1 text-black hover:bg-yellow-600"
            >
              Review & Merge (Custom Logic)
            </button>
          </div>
          <div class="mt-2 text-xs">
            <p><strong>Your version:</strong></p>
            <pre>{{ conflictState.localData | json }}</pre>
            <p class="mt-1"><strong>External version:</strong></p>
            <pre>{{ conflictState.externalData | json }}</pre>
          </div>
        </div>
      }
    }
    -->

    <div class="mt-6 rounded-lg border border-gray-200 bg-gray-50 p-4 text-xs">
      <h3 class="mb-2 text-sm font-semibold">Form State:</h3>
      <pre>{{ profileForm.formState() | json }}</pre>
    </div>

    <div class="mt-6 rounded-lg border border-gray-200 bg-gray-50 p-4 text-xs">
      <h3 class="mb-2 text-sm font-semibold">Form State:</h3>
      <pre>{{ profileForm.formState() | json }}</pre>
    </div>
    <div class="mt-6 rounded-lg border border-gray-200 bg-gray-50 p-4 text-xs">
      <h3 class="mb-2 text-sm font-semibold">External Data:</h3>
      <pre>{{ externalUserData() | json }}</pre>
    </div>
  </form>
</div>
